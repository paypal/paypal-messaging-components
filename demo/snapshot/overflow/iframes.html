<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Messaging.js Dev Sandbox</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
        <script src="//localhost.paypal.com:8080/messaging.js" data-pp-account="DEV0000000GPL"></script>

        <style>
            body {
                margin: 0;
            }
            .row {
                height: 100vh;
                background: linear-gradient(#cfd8dc, #37474f);
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
            }
            .iframe-wrapper {
                width: 100vw;
                display: flex;
                flex-grow: 1;
                justify-content: space-between;
                column-gap: 10px;
            }
            .iframe {
                /*
                    Set the iframes to take up the whole row;
                    four iframes have static heights though: ;
                        - one 1x1 iframe set to 150px by 150px 
                        - one 1x1 iframe set to 50px height
                        - one text iframe set to 20px height
                        - one 1x1 iframe set to 50px height
                */
                height: calc((100vh - (150px + 50px + 20px + 42px)) / (9 - 4));
                background: linear-gradient(#b0bec5, #eceff1);
                flex-grow: 1;
            }
            .annotation {
                width: 50px;
                text-align: center;
                font-family: sans-serif;
            }
        </style>
    </head>

    <body>
        <!-- 
            @name: iframe messages render below the fold
            @viewport: 400x500
        -->

        <script>
            const query = window.location.search.substring(1);
            const mappedParams = query.split('&').reduce((accumulator, param) => {
                const [key, value] = param.split('=');
                accumulator[key] = decodeURIComponent(value);
                return accumulator;
            }, {});

            const config = JSON.parse(mappedParams.config ?? '{}');

            const iframeSrcPage = `../_iframe.html`;
            const getIframe = attrs => {
                const iframe = document.createElement('iframe');
                iframe.classList.add('iframe');
                Object.entries({
                    frameborder: '0',
                    'data-test-visible': true,
                    ...attrs
                }).map(([attributeName, attributeValue]) => {
                    if (attributeName === 'data-test-visible') {
                        if (attributeValue) {
                            iframe.classList.add('visible');
                        } else {
                            iframe.classList.add('hidden');
                        }
                    }
                    iframe.setAttribute(attributeName.replace('iframe-', ''), attributeValue);
                });
                return iframe;
            };

            const body = document.querySelector('body');

            // each row is as tall as the viewport, and contains iframes to test each layout
            Array.from({ length: 2 }).forEach(() => {
                const row = document.createElement('div');
                row.classList.add('row');
                [
                    // We expect the first set of iframes to be visible
                    {
                        bannerStyle: { layout: 'flex', ratio: '1x1' },
                        'iframe-style': 'width:150px;height:150px;flex-grow:0;'
                    },
                    { bannerStyle: { layout: 'flex', ratio: '8x1' } },
                    { bannerStyle: { layout: 'text' } },
                    // but we expect the next set to not be visible because they do not have enough space
                    {
                        bannerStyle: { layout: 'flex', ratio: '1x1' },
                        'data-test-visible': false,
                        'iframe-style': 'height:50px;'
                    },
                    {
                        bannerStyle: { layout: 'flex', ratio: '1x1' },
                        'data-test-visible': false,
                        'iframe-style': 'width:50px;flex-grow:0;'
                    },
                    {
                        bannerStyle: { layout: 'flex', ratio: '8x1' },
                        'data-test-visible': false,
                        'iframe-style': 'width:50px;flex-grow:0;'
                    },
                    {
                        bannerStyle: { layout: 'text' },
                        'data-test-visible': false,
                        'iframe-style': 'width:50px;flex-grow:0;'
                    },
                    {
                        bannerStyle: { layout: 'text' },
                        'data-test-visible': false,
                        'iframe-style': 'height:20px;width:270px;flex-grow:0;'
                    },
                    {
                        bannerStyle: { layout: 'text', text: { size: 16 } },
                        'data-test-visible': false,
                        'iframe-style': 'height:42px;width:140px;flex-grow:0;'
                    }
                ].forEach(({ bannerStyle, iframeStyle, ...config }) => {
                    const configStyle = config?.style ?? {};
                    const queryParams = Object.entries({
                        ...mappedParams,
                        config: {
                            ...config,
                            style: {
                                ...configStyle,
                                ...bannerStyle
                            }
                        }
                    }).reduce((acc, [key, val]) => {
                        let stringifiedValue = `${val}`;
                        // if (typeof val !== 'undefined' && val !== null){
                        if (typeof val === 'object') {
                            stringifiedValue = JSON.stringify(val);
                            // v = val
                        }
                        // if (val === null || typeof val === undefined){

                        // }
                        return `${acc.length === 0 ? `?` : `${acc}&`}${key}=${stringifiedValue}`;
                    }, '');
                    const src = `${iframeSrcPage}?${queryParams}`;
                    const iframeWrapper = document.createElement('div');
                    const iframe = getIframe({ src, ...config });
                    const annotation = document.createElement('span');
                    iframeWrapper.classList.add('iframe-wrapper');
                    annotation.classList.add('annotation');
                    annotation.innerText = iframe.getAttribute('data-test-visible');
                    // row.appendChild(iframe);
                    // row.appendChild(annotation);
                    iframeWrapper.appendChild(iframe);
                    iframeWrapper.appendChild(annotation);
                    row.appendChild(iframeWrapper);
                    return iframe;
                });
                body.appendChild(row);
            });
        </script>
    </body>
</html>
